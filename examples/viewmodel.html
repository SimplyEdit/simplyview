<!doctype html>
<html>
<head>
	<script src="https://cdn.jsdelivr.net/npm/superagent"></script>
	<link rel="stylesheet" type="text/css" href="css/styles.css">
</head>
<body>
<header class="ds-space ds-navbar">
	<div class="demo-search">
		<input type="text" placeholder="Search..." data-simply-command="search" data-simply-immediate="1">
	</div>
	<div class="ds-paging ds-navbar-right" style="margin-right: 0">
		<div class="ds-align-right" data-simply-field="movies.options.paging.max" data-simply-content="template" data-simply-default-template="n">
			<template data-simply-template="1">
			</template>
			<template data-simply-template="n">
			    <ul class="ds-navbar-nav ds-paging">
			        <li>
			            <button data-simply-command="movies-prevpage" class="ds-button" disabled="" title="vorige pagina" 
			            	data-simply-field="movies.options.paging.prev" data-simply-content="fixed" data-simply-transformer="enable">
			            	<svg class="ds-icon ds-icon-feather"><use xlink:href="css/feather-sprite.svg#chevron-left"></use></svg>
			            </button>
			        </li>
			        <li class="ds-paging-info">
			            <span data-simply-field="movies.options.paging.page">1</span> /
			            <span data-simply-field="movies.options.paging.max">10</span>
			        </li>
			        <li>
			            <button data-simply-command="movies-nextpage" class="ds-button" title="volgende pagina" 
			            	data-simply-field="movies.options.paging.next" data-simply-transformer="enable">
			            	<svg class="ds-icon ds-icon-feather"><use xlink:href="css/feather-sprite.svg#chevron-right"></use></svg>
			            </button>
			            <button data-simply-command="movies-nextpage" class="ds-button" title="volgende pagina" 
			            	data-simply-field="movies.paging.next" data-simply-transformer="enable">
			            	<svg class="ds-icon ds-icon-feather"><use xlink:href="css/feather-sprite.svg#chevron-right"></use></svg>
			            </button>
			        </li>
			    </ul>
			</template>
		</div>
		<select class="ds-align-right" style="width: 200px;" 
			data-simply-list="movie-genres" data-simply-data="movie-genres" data-simply-entry="genre"
			data-simply-command="genre" data-simply-field="movies.options.genreFilter.genre"
		>
			<template>
				<option data-simply-field="genre"></option>
			</template>
		</select>
	</div>
</header>
<main class="ds-space ds-scrollbox" style="--ds-scrollbox-height: 65vh">
	<table class="ds-datatable ds-datatable-sticky-header">
	<thead>
		<tr>
			<th data-simply-command="sort" data-simply-value="title" data-simply-field="movies.options.sort" data-simply-content="fixed" data-simply-transformer="movies-sort">title</th>
			<th data-simply-command="sort" data-simply-value="year" data-simply-field="movies.options.sort" data-simply-content="fixed" data-simply-transformer="movies-sort">year</th>
			<th class="ds-datatable-disable-sort">genre</th>
		</tr>
	</thead>
	<tbody data-simply-list="movies" data-simply-data="movies">
		<template>
			<tr>
				<td data-simply-field="title"></td>
				<td data-simply-field="year"></td>
				<td data-simply-field="genres" data-simply-transformer="movies-genres"></td>
			</tr>
		</template>
	</tbody>
	</table>
</main>

<script src="https://cdn.simplyedit.io/1/simply-edit.js"></script>
<script src="../dist/simply.everything.js"></script>
<script>	
	var movies, movieApp;
	;
	document.addEventListener('simply-content-loaded',function() {
		superagent
		.get('https://raw.githubusercontent.com/prust/wikipedia-movie-data/master/movies.json')
		.then(function(result) {
			if (result.ok) {
				return JSON.parse(result.text);
			}
		})
		.then(function(json) {
			// create viewmodel with the result and paging
			// viewmodel should also set a data source

			var genres = json.flatMap(m => m.genres);
			var distinctGenres = Array.from(new Set(genres)).map(g => { return {value: g, innerHTML: g}});
			
			distinctGenres.unshift({ value: '', innerHTML: 'All genres'});
			//FIXME: adding an empty string to an array of strings doesn't work - doesn't get rendered
			//so made an array of objects instead.
			
			editor.addDataSource('movie-genres',{
				load: function(el, callback) {
					callback(distinctGenres);
				}
			});

			movieApp = simply.app({
				commands: {
					'search': function(el, value) {
						movies.update({
							titleSearch: {
								search: value
							}
						});
					},
					'movies-nextpage': function(el, value) {
						movies.update({
							paging: {
								page: movies.options.paging.page + 1
							}
						});
					},
					'movies-prevpage': function(el, value) {
						movies.update({
							paging: {
								page: movies.options.paging.page - 1
							}
						});
					},
					'sort': function(el, value) {
						var asc = !el.classList.contains('ds-datatable-sorted-ascending');
						movies.update({
							sort: {
								sortBy: value,
								sortOrder: asc ? 'ASC' : 'DESC'
							}
						});
					},
					'genre': function(el, value) {
						movies.update({
							genreFilter: {
								genre: value
							}
						});
					}
				}
			});
			
			movies = simply.viewmodel.create('movies');

			movies.addPlugin('select', simply.viewmodel.createFilter({
				name: 'titleSearch',
				getMatch: function(params) {
					if (params.search && params.search.length>2) {
						var re = new RegExp(params.search, 'i');
						return function(movie) {
							return re.test(movie.title);
						}
					}
				}					
			}));

			movies.addPlugin('select', function() {
				var currentGenres = this.view.data.flatMap(m => m.genres);
				var distinctGenres = new Set(currentGenres);
				var genres = document.querySelector('[data-simply-data="movie-genres"]');
				Array.from(genres.options).forEach(function(genre) {
					if (genre.value && !distinctGenres.has(genre.value)) {
						genre.disabled = 'disabled';
					} else {
						genre.removeAttribute('disabled');
					}
				});
			});

			movies.addPlugin('select', simply.viewmodel.createFilter({
				name: 'genreFilter',
				getMatch: function(params) {
					if (params.genre) {
						return function(movie) {
							return movie.genres && movie.genres.indexOf(params.genre)>=0;
						}
					}
				}
			}));
			

			movies.addPlugin('order', simply.viewmodel.createSort({
				name: 'sort',
				getSort: function(params) {
					this.view.sort = params;
					if (params.sortOrder == 'ASC') {
						var leftReturn = -1;
						var rightReturn = 1;
					} else {
						var leftReturn = 1;
						var rightReturn = -1;
					}
					switch (params.sortBy) {
						case 'title':
							return function(a,b) {
								return a.title<b.title ? leftReturn : rightReturn;
							}
						break;
						case 'year':
							return function(a,b) {
								return a.year<b.year ? leftReturn : rightReturn;
							}
						break;
					};
				}
			}));

			
			movies.addPlugin('render', simply.viewmodel.createPaging());
			
			movies.addPlugin('finish', function() {
				// waarom werkt dit wel voor de next button
				// en waarom is de prev button wel goed?
				movieApp.view.movies.paging = movies.options.paging;
			});
			
			// only copy the options into the app view, the data should only be 
			// linked through a datasource - for performance
			movieApp.view.movies = {
				options: movies.view.options
			};

			movies.update({
				data: json
			});
			
			editor.transformers['movies-sort'] = {
				render: function(data) {
					this.originalValue = data;
					this.classList.remove('ds-datatable-sorted-descending');
					this.classList.remove('ds-datatable-sorted-ascending');
					if (data.sortBy==this.innerHTML) {
						this.classList.add(data.sortOrder=='ASC' ? 'ds-datatable-sorted-ascending':'ds-datatable-sorted-descending');
					}
					return data;
				},
				extract: function() {
					return this.originalValue;
				}
			};

			editor.transformers['movies-genres'] = {
				render: function(data) {
					if (data) {
						this.originalValue = data;
						data = data.slice().join(', ');
						this.innerHTML = data;
					}
					return data;
				},
				extract: function() {
					return this.originalValue || [];
				}
			};

			editor.transformers['enable'] = {
				render: function(data) {
					this.originalValue = data;
					if (data) {
						this.disabled = false;
					} else {
						this.disabled = true;
					}
					return data;
				},
				extract: function() {
					return this.originalValue;
				}
			};
			
		})
		.catch(console.error);
	});
</script>
</body>
</html>