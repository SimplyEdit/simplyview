<h1>two way databinding to multiple fields with simple api</h1>
<h2>performance test with faster setter</h2>
<script>
var simply = (function(simply) {
	function getKey(el) {
		return el.dataset.bind;
	}

	var shadows = new WeakMap();

	var focusedElement = null;

	/**
	 * Returns an object which stores the original value of model[path]
	 */
	function getShadow(model, path) {
		if (!shadows.has(model)) {
			shadows.set(model, {});
		}
		var root = shadows.get(model);
		if (typeof root[path] == 'undefined') {
			root[path] = {
				value: {},
				elements: [],
				children: {}
			};
		}
		return root[path];
	}

	/**
	 * keeps a list of elements linked to the jsonPath in rootModel
	 */
	function registerField(rootModel, jsonPath, el) {
		var shadow = getShadow(rootModel, jsonPath);
		var elements = shadow.elements;
		elements.push(el);
	}

	function getElements(rootModel, path) {
		var shadow = getShadow(rootModel, path);
		return shadow.elements;
	}

	function setValue(elements, value, self) {
		self.observer.disconnect();
		elements.forEach(function(el, index) {
			if (!document.body.contains(el)) {
				elements.splice(index, 1);
			}
			if (el!=focusedElement) {
				el.innerHTML = value;
			}
		});
		self.observer.observe(document.body, {
        	subtree: true,
        	childList: true,
        	characterData: true
        });
	}

	function copyDescriptor(shadow, model, key, value) {
		// copy the exact property from the model to the shadow
		descriptor = Object.getOwnPropertyDescriptor(model, key);
		if (!descriptor) {
			// property unknown in the model, copy it from html
			descriptor = {
				value: value
			}
		}
		Object.defineProperty(shadow, key, descriptor);
	}

	function findChildren(path) {
		return [];
	}

	function attachChildren(children, rootModel, parentPath) {
		rootShadow = getShadow(rootModel, parentPath);
		for (var child of children) {
			shadow = getShadow(rootModel, parentPath+'.'+child);
			//FIXME: te complex... moet simpeler, start from step5.performace.html again
		}
	}

	function attachElement(rootModel, path, el, self) {
		if (!document.body.contains(el)) {
			// element is no longer part of the document
			// so don't bother changing the model or updating the element for it
			return;
		}
		// register the field
		registerField(rootModel, path, el);

		var keys = path.split('.');
		var key, shadow, model, descriptor;
		var parentPath = '';
		do {
			key    = keys.shift();
			shadow = getShadow(rootModel, parentPath);
			model  = getByPath(rootModel, parentPath);
			if (typeof shadow.value[key] == 'undefined') {
				copyDescriptor(shadow.value, model, key, keys.length ? {} : getValue(el));
				// create a setter so we know when to update the bound element
				// this means we also need a getter
				Object.defineProperty(model, key, {
					set: (function(shadow, parentPath, key) {
						return function(value) {
							shadow.value[key] = value;
							var nextPath = (parentPath ? parentPath + '.' : '') + key;
							var children = findChildren(nextPath);
							if (children.length) {
								attachChildren(children, rootModel, nextPath);
								//FIXME: update elements linked to sub properties - even if the subproperties are no longer defined in the model
								//attachSubProperty(rootModel, path, el, parentPath);
							}
							var elements = getElements(rootModel, nextPath)
							if (elements) {
								setValue(elements, value, self);
							}
						};
					})(shadow, parentPath, key),
					get: (function(shadow, key) {
						return function() {
							return shadow.value[key];
						};
					})(shadow, key),
					configurable: true // allow to override earlier defineProperty calls
				});
			}
			parentPath = (parentPath ? parentPath + '.' : '' ) + key;
		} while(keys.length);

		setValue(getShadow(rootModel, path).elements, model[key], self);
	}


	function getValue(el) {
		return el.innerHTML;
	}

	function getByPath(model, path) {
		if (!path) {
			return model;
		}
		return path.split('.').reduce(function(acc, name) {
			return (acc[name] ? acc[name] : null);
		}, model);
	}

	function getParentPath(path) {
		path = path.split('.');
		path.pop();
		return path.join('.');
	}

	function getLastName(path) {
		path = path.split('.');
		return path.pop();
	}

	function updateValue(model, path, value) {
		var parentOb = getByPath(model, getParentPath(path));
		parentOb[getLastName(path)] = value;
	}
	
	function throttle( callbackFunction, intervalTime ) {
		var eventId = 0;
		return function() {
			var myArguments = arguments;
			var me = this;
			if ( eventId ) {
				return;
			} else {
				eventId = window.setTimeout( function() {
					callbackFunction.apply(me, myArguments);
					eventId = 0;
				}, intervalTime );
			}
		}
	}

	simply.bind = function(config) {
		return new Binding(config);
	};

	function getElement(node) {
		if (node.nodeType != Node.ELEMENT_NODE) {
			return node.parentElement;
		}
		return node;
	}

	function Binding(config) {
		this.config = config;
		if (!this.config) {
			this.config = {};
		}
		if (!this.config.model) {
			this.config.model = {};
		}
		if (!this.config.selector) {
			this.config.selector = '[data-bind]';
		}

		this.observer = observe(document.body, this);

		attach(this.config.model, this.config.selector, this);

	};

	function attach(model, selector, self) {
		[].forEach.call(document.querySelectorAll(selector), function(element) {
            var key = getKey(element);
            attachElement(model, key, element, self);
        });
	};

	function observe(root, binding) {
		var changes = [];
		var handleChanges = throttle(function() {
			changes = changes.concat(observer.takeRecords());
			observer.disconnect();
			var change,el;
			var handled = {}; // list of keys already handled
			for (var i=changes.length-1; i>=0; i--) {
				// handle last change first, so programmatic changes are predictable
				// last change overrides earlier changes
				change = changes[i];
				el = getElement(change.target);
				if (el && !el.matches(binding.config.selector)) {
					el = el.closest(binding.config.selector);
				}
				if (el) {
					var key = getKey(el);
					if (handled[key]) {
						// we already handled this key, the model is uptodate
						continue;
					}
					handled[key] = true;
					focusedElement = el;
					updateValue(binding.config.model, key, getValue(el));
					focusedElement = null;
				}
			}
			observer.observe(root, {
	        	subtree: true,
	        	childList: true,
	        	characterData: true				
			});
		},100);
        var observer = new MutationObserver(function(changeList) {
        	changes = changes.concat(changeList);
        	handleChanges();
        });
        observer.observe(root, {
        	subtree: true,
        	childList: true,
        	characterData: true
        });
        return observer;
	}  
    return simply;
})(simply || {});
</script>

<h1 contenteditable=true data-bind="title">title</h1>
<p contenteditable=true data-bind="description">description</p>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>

<script>
  var model = {
    title: "A nice title",
    user: {
      name: "Mr. User",
      email: "user@example.org"
    }
  };
  
  var bindings = simply.bind({
  	model: model
  });
</script>
<h2>Try:</h2>
<p>Typing in one of the fields with 'A nice title'. Both fields should change.
<p>Or try:
<pre>
	model.user = null;
</pre>
<p>And then type in one of the user fields (name or email)
<p>The user name and email should become available again in model.user.

<pre>

var bindings = simply.bind
.config({
	getPath: function(el) {
		return el.dataset.bind;
	},
	fieldTypes: {
		'*': {
			set: function(el, value) {
				el.innerHTML = value;
			},
			get: function(el) {
				return el.innerHTML
			}
		}
	},
	model: model,
})
.attach(document.querySelectorAll('[data-bind]'));

bindings.attach(moreElements);

// this call should update all the matching fields immediately
bindings.addFieldType('input', {
	set: function(el, value) {
		el.value = value;
	},
	get: function(el) {
		return el.value;
	}
});
</pre>