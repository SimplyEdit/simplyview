<h1>one way and two way databinding to multiple fields with simple api</h1>
<h2>mutation observer and no nested setters</h2>
<script>
var simply = (function(simply) {

	/*** utility functions ****/	
	function throttle( callbackFunction, intervalTime ) {
		var eventId = 0;
		return function() {
			var myArguments = arguments;
			var me = this;
			if ( eventId ) {
				return;
			} else {
				eventId = window.setTimeout( function() {
					callbackFunction.apply(me, myArguments);
					eventId = 0;
				}, intervalTime );
			}
		}
	}

	function getElement(node) {
		if (node.nodeType != Node.ELEMENT_NODE) {
			return node.parentElement;
		}
		return node;
	}

	function getByPath(model, path) {
		if (!path) {
			return model;
		}
		return path.split('.').reduce(function(acc, name) {
			return (acc && acc[name] ? acc[name] : null);
		}, model);
	}

	function getLastKey(path) {
		return path.split('.').pop();
	}

	function updateValue(model, path, value) {
		var pathNames = path.split('.');
		var last = pathNames.pop();
		var parentOb = pathNames.reduce(function(acc, name) {
			if (!acc[name]) {
				// attach chain is broken here, repair it
				acc[name] = {}
			}
			return acc[name];
		}, model);
		parentOb[last] = value;
	}

	/*** functions that should be configurable ****/
	function getPath(el) {
		return el.dataset.bind;
	}

	function setValue(el, value) {
		if (el!=focusedElement) {
			el.innerHTML = (typeof value != 'undefined' ? value : '');
		}
	}

	function getValue(el) {
		return el.innerHTML;
	}


	/*** shadow values ***/
	var shadows = new WeakMap();
	var focusedElement = null;
	/**
	 * Returns an object which has the original value of model[key]
	 * If this value was a getter/setter, the shadow object also has
	 * a setter/getter.
	 */
	function getShadow(model, jsonPath) {
		if (!shadows.has(model)) {
			shadows.set(model, {});
		}
		var root = shadows.get(model);
		if (typeof root[jsonPath] == 'undefined') {
			root[jsonPath] = {
				value: null,
				elements: [],
				children: {}
			};
		}
		return root[jsonPath];
	}


	function Binding(config) {
		this.config = config;
		if (!this.config) {
			this.config = {};
		}
		if (!this.config.model) {
			this.config.model = {};
		}
		if (!this.config.selector) {
			this.config.selector = '[data-bind]';
		}

		this.attach(document.querySelectorAll(this.config.selector));
	};

	Binding.prototype.attach = function(elements) {
		var self = this;
		var attachElement = function(rootModel, jsonPath, el) {
			if (!document.body.contains(el)) {
				// element is no longer part of the document
				// so don't bother changing the model or updating the element for it
				return;
			}
			var keys       = jsonPath.split('.'),
			    parentPath = '',
			    path       = '',
			    shadow,
			    model      = rootModel;

			do {
				key    = keys.shift();
				path   = (parentPath ? parentPath + '.' : '') + key;
				shadow = getShadow(rootModel, path);
				if (keys.length) {
					shadow.children[ path + '.' + keys[0]] = true;
				}
				if (model && typeof model == 'object') {
					shadow.value = model[key];
					Object.defineProperty(model, key, {
						set: (function(shadow) {
							return function(value) {
								shadow.value = value;
								updateElements(shadow.elements, value);
								attachChildren(rootModel, shadow);
								addSetTriggers(rootModel, shadow);
							};
						})(shadow),
						get: (function(shadow) {
							return function() {
								return shadow.value;
							}
						})(shadow),
						configurable: true,
						enumerable: true
					});
					model = model[key];
				}
				parentPath = path;
			} while(keys.length);
			if (shadow.elements.indexOf(el)==-1) {
				shadow.elements.push(el);
			}
			updateElements([el], model);
		};

		var updateElements = function(elements, value) {
			var reconnectObserver;
			if (self.observing) {
				self.observer.disconnect();
				self.observing = false;
				reconnectObserver = true;
			}
			elements.forEach(function(el, index) {
				if (document.body.contains(el)) {
					setValue(el, value);
				} else {
					elements.splice(index,1);
				}
			});
			if (reconnectObserver) {
		        self.observing = true;
				self.observer.observe(document.body, {
		        	subtree: true,
		        	childList: true,
		        	characterData: true
		        });
		    }
		};

		var attachChildren = function(model, shadow) {
			// FIXME: if shadow.value is set null or {}
			// the setters for each child must reinstate the bindings
			// but only for elements which are in the dom
			Object.keys(shadow.children).forEach(function(child) {
				var value = getByPath(model, child);
				var childShadow = getShadow(model, child);
				childShadow.value = value;
				childShadow.elements.forEach(function(el) {
					attachElement(model, child, el, self);
				});
			});
		};

		var addSetTriggers = function(model, shadow){
			Object.keys(shadow.children).forEach(function(childPath) {
				var name = getLastKey(childPath);
				if (shadow.value && typeof shadow.value[name] == 'undefined') {
					Object.defineProperty(shadow.value, name, {
						set: function(value) {
							restoreBinding(model, childPath);
							shadow.value[name] = value;
						},
						configurable: true,
						enumerable: false
					});
				}
			});
		}

		var restoreBinding = function(model, path) {
			var shadow = getShadow(model, path);
			[].forEach.call(shadow.elements, function(element) {
            	attachElement(model, path, element);
        	});
		}

		if ( elements instanceof HTMLElement ) {
			elements = [ elements ];
		}
		[].forEach.call(elements, function(element) {
            var key = getPath(element);
            attachElement(self.config.model, key, element);
        });
	};

	Binding.prototype.observe = function(root) {
		var changes = [];
		var self    = this;

		var handleChanges = throttle(function() {
			changes = changes.concat(self.observer.takeRecords());
			self.observer.disconnect();
			self.observing = false;
			var change,el;
			var handled = {}; // list of keys already handled
			for (var i=changes.length-1; i>=0; i--) {
				// handle last change first, so programmatic changes are predictable
				// last change overrides earlier changes
				change = changes[i];
				el = getElement(change.target);
				if (el && !el.matches(self.config.selector)) {
					el = el.closest(self.config.selector);
				}
				if (el) {
					var key = getPath(el);
					if (handled[key]) {
						// we already handled this key, the model is uptodate
						continue;
					}
					handled[key] = true;
					focusedElement = el;
					updateValue(self.config.model, key, getValue(el));
					focusedElement = null;
				}
			}
			self.observing = true;
			self.observer.observe(root, {
	        	subtree: true,
	        	childList: true,
	        	characterData: true				
			});
		},100);
        this.observer = new MutationObserver(function(changeList) {
        	changes = changes.concat(changeList);
        	handleChanges();
        });
        this.observing = true;
        this.observer.observe(root, {
        	subtree: true,
        	childList: true,
        	characterData: true
        });
        return this.observer;
	};

	Binding.prototype.stopObserver = function() {
		this.observer.disconnect();
		this.observing = false;
	};

	simply.bind = function(config) {
		return new Binding(config);
	};

    return simply;
})(simply || {});
</script>

</script>

<h1 contenteditable=true data-bind="title">title</h1>
<p contenteditable=true data-bind="description">description</p>
<div><label>Name:</label><span contenteditable="true" data-bind="user.name"></span></div>
<div><label>Email:</label><span contenteditable="true" data-bind="user.email"></span></div>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>
<pre contenteditable=true data-bind="title"></pre>

<script>
  window.model = {
    title: "A nice title",
    user: {
      name: "Mr. User",
      email: "user@example.org"
    }
  };
  
  var bindings = simply.bind({
  	model: window.model
  }).observe(document.body);
</script>
<h2>Try:</h2>
<p>Typing in one of the fields with 'A nice title'. All fields should change.
<p>Or try:
<pre>
	//FIXME: this breaks now
	model.user = null;
</pre>
<p>And then type in one of the user fields (name or email)
<p>The user name and email should become available again in model.user.

<p>one way databinding:</p>
<pre>

var bindings = simply.bind({
	model: model,
	selector: '[data-bind]'
});

</pre>
<p>two way databinding:</p>

<pre>
var bindings = simply.bind({
	model: model,
	selector: '[data-bind]'
});
.observe(document.body);

</pre>