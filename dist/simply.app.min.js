(()=>{function j(t){return new M(t)}var M=class{constructor(e={}){this.root=e.root||"/",this.app=e.app,this.clear(),e.routes&&this.load(e.routes)}load(e){Y(e,this.routeInfo)}clear(){this.routeInfo=[],this.listeners={match:{},call:{},finish:{}}}match(e,n){let r={path:e,options:n};r=this.runListeners("match",r),e=r.path?r.path:e;let s;if(!e)return this.match(document.location.pathname+document.location.hash)?!0:this.match(document.location.pathname);e=b(e);for(let l of this.routeInfo)if(s=l.match.exec(e),s&&s.length){var i={};return l.params.forEach((f,o)=>{f=="*"&&(f="remainder"),i[f]=s[o+1]}),Object.assign(i,n),r.route=l,r.params=i,r=this.runListeners("call",r),i=r.params?r.params:i,r.result=l.action.call(l,i),this.runListeners("finish",r),r.result}return e&&e[e.length-1]!="/"?this.match(e+"/",n):!1}runListeners(e,n){if(Object.keys(this.listeners[e]))return Object.keys(this.listeners[e]).forEach(r=>{var s=K(r);if(s.exec(n.path)){var i;for(let l of this.listeners[e][r])i=l.call(this.app,n),i&&(n=i)}}),n}handleEvents(){globalThis.addEventListener("popstate",()=>{this.match(b(document.location.pathname+document.location.hash,this.root))===!1&&this.match(b(document.location.pathname,this.root))}),globalThis.document.addEventListener("click",e=>{if(!e.ctrlKey&&e.which==1){for(var n=e.target;n&&n.tagName!="A";)n=n.parentElement;if(n&&n.pathname&&n.hostname==globalThis.location.hostname&&!n.link&&!n.dataset.simplyCommand){let r=b(n.pathname+n.hash,this.root);if(this.has(r)||(r=b(n.pathname,this.root)),this.has(r)){let s=this.runListeners("goto",{path:r});return s.path&&this.goto(s.path),e.preventDefault(),!1}}}})}goto(e){return history.pushState({},"",X(e)),this.match(e)}has(e){e=b(e,this.root);for(let r of this.routeInfo){var n=r.match.exec(e);if(n&&n.length)return!0}return!1}addListener(e,n,r){if(["goto","match","call","finish"].indexOf(e)==-1)throw new Error("Unknown action "+e);this.listeners[e][n]||(this.listeners[e][n]=[]),this.listeners[e][n].push(r)}removeListener(e,n,r){if(["match","call","finish"].indexOf(e)==-1)throw new Error("Unknown action "+e);this.listeners[e][n]&&(this.listeners[e][n]=this.listeners[e][n].filter(s=>s!=r))}init(e){e.root&&(this.root=e.root)}};function b(t,e="/"){return(t.substring(0,e.length)==e||e[e.length-1]=="/"&&t.length==e.length-1&&t==e.substring(0,t.length))&&(t=t.substring(e.length)),t[0]!="/"&&t[0]!="#"&&(t="/"+t),t}function X(t,e){return t=b(t,e),e[e.length-1]==="/"&&t[0]==="/"&&(t=t.substring(1)),e+t}function K(t){return new RegExp("^"+t.replace(/:\w+/g,"([^/]+)").replace(/:\*/,"(.*)"))}function Y(t){let e=[],n=Object.keys(t),r=/:(\w+|\*)/g;for(let s of n){let i=[],l=[];do i=r.exec(s),i&&l.push(i[1]);while(i);e.push({match:K(s),params:l,action:t[s]})}return e}var P=class{constructor(e={}){e.app||(e.app={}),e.app.container||(e.app.container=document.body),this.app=e.app,this.handlers=e.handlers||_,this.commands=e.commands||{};let n=r=>{let s=Z(r,this.handlers);if(!s)return;if(!this.commands[s.name]){console.error("simply.command: undefined command "+s.name,s.source);return}if(this.commands[s.name].call(this.app,s.source,s.value)===!1)return r.preventDefault(),r.stopPropagation(),!1};this.app.container.addEventListener("click",n),this.app.container.addEventListener("submit",n),this.app.container.addEventListener("change",n),this.app.container.addEventListener("input",n)}};function $(t={}){return new P(t)}function Z(t,e){var n=t.target.closest("[data-simply-command]");if(n){for(let r of e)if(n.matches(r.match))return r.check(n,t)?{name:n.dataset.simplyCommand,source:n,value:r.get(n)}:null}return null}var _=[{match:"input,select,textarea",get:function(t){if(t.tagName==="SELECT"&&t.multiple){let e=[];for(let n of t.options)n.selected&&e.push(n.value);return e}return t.dataset.simplyValue||t.value},check:function(t,e){return e.type=="change"||t.dataset.simplyImmediate&&e.type=="input"}},{match:"a,button",get:function(t){return t.dataset.simplyValue||t.href||t.value},check:function(t,e){return e.type=="click"&&e.ctrlKey==!1&&e.button==0}},{match:"form",get:function(t){let e={};for(let n of Array.from(t.elements)){if(n.tagName=="INPUT"&&(n.type=="checkbox"||n.type=="radio")&&!n.checked)return;e[n.name]&&!Array.isArray(e[n.name])&&(e[n.name]=[e[n.name]]),Array.isArray(e[n.name])?e[n.name].push(n.value):e[n.name]=n.value}return e},check:function(t,e){return e.type=="submit"}},{match:"*",get:function(t){return t.dataset.simplyValue},check:function(t,e){return e.type=="click"&&e.ctrlKey==!1&&e.button==0}}];function U(t){if(t.app){let e={get:(n,r)=>n[r].bind(t.app)};return new Proxy(t.actions,e)}else return t}var I=class{constructor(e={}){e.app||(e.app={}),e.app.container||(e.app.container=document.body),this.keys=e.keys||{},this.app=e.app,this.app.container.addEventListener("keydown",this.keyHandler())}keyHandler(){return e=>{if(e.isComposing||e.keyCode===229||e.defaultPrevented||!e.target)return;let n="default";e.target.closest("[data-simply-keyboard]")&&(n=e.target.closest("[data-simply-keyboard]").dataset.simplyKeyboard);let r="";e.ctrlKey&&e.keyCode!=17&&(r+="Control+"),e.metaKey&&e.keyCode!=224&&(r+="Meta+"),e.altKey&&e.keyCode!=18&&(r+="Alt+"),e.shiftKey&&e.keyCode!=16&&(r+="Shift+"),r+=e.key,this.keys[n]&&this.keys[n][r]&&this.keys[n][r].call(this.app,e)}}};function D(t={}){return new I(t)}var O=Symbol("iterate");Symbol.xRay||(Symbol.xRay=Symbol("xRay"));var ee={get:(t,e,n)=>{if(e===Symbol.xRay)return t;let r=t?.[e];return R(n,e),typeof r=="function"?Array.isArray(t)?(...s)=>{let i=t.length,l=r.apply(n,s);return i!=t.length&&w(n,g("length",{was:i,now:t.length})),l}:t instanceof Set||t instanceof Map?(...s)=>{let i=t.size,l=r.apply(t,s);return i!=t.size&&w(n,g("size",{was:i,now:t.size})),["set","add","clear","delete"].includes(e)&&w(n,g({entries:{},forEach:{},has:{},keys:{},values:{},[Symbol.iterator]:{}})),l}:r.bind(n):r&&typeof r=="object"?C(r):r},set:(t,e,n,r)=>{n=n?.[Symbol.xRay]||n;let s=t[e];return s!==n&&(t[e]=n,w(r,g(e,{was:s,now:n}))),typeof s>"u"&&w(r,g(O,{})),!0},has:(t,e)=>{let n=y.get(t);return n&&R(n,e),Object.hasOwn(t,e)},deleteProperty:(t,e)=>{if(typeof t[e]<"u"){let n=t[e];delete t[e];let r=y.get(t);w(r,g(e,{delete:!0,was:n}))}return!0},defineProperty:(t,e,n)=>{if(typeof t[e]>"u"){let r=y.get(t);w(r,g(O,{}))}return Object.defineProperty(t,e,n)},ownKeys:t=>{let e=y.get(t);return R(e,O),Reflect.ownKeys(t)}},y=new WeakMap;function C(t){return y.has(t)||y.set(t,new Proxy(t,ee)),y.get(t)}var V=new Set,te=0;function w(t,e={}){let n=[];if(e.forEach((r,s)=>{let i=se(t,s);if(i?.length){for(let l of i)ne(l,g(s,r));n=n.concat(i)}}),n=new Set(n.filter(Boolean)),n)if(te)V=V.union(n);else{let r=k[k.length-1];for(let s of Array.from(n))s!=r&&s?.needsUpdate&&s(),re(s)}}function g(t,e){let n=new Map;if(typeof t=="object")for(let r in t)n.set(r,t[r]);else n.set(t,e);return n}function ne(t,e){t.context?e.forEach((n,r)=>{t.context.set(r,n)}):t.context=e,t.needsUpdate=!0}function re(t){delete t.context,delete t.needsUpdate}function R(t,e){let n=k[k.length-1];n&&ie(t,e,n)}var v=new WeakMap,S=new WeakMap;function se(t,e){let n=v.get(t);return n?Array.from(n.get(e)||[]):[]}function ie(t,e,n){v.has(t)||v.set(t,new Map);let r=v.get(t);r.has(e)||r.set(e,new Set),r.get(e).add(n),S.has(n)||S.set(n,new Map);let s=S.get(n);s.has(e)||s.set(e,new Set),s.get(e).add(t)}function F(t){let e=S.get(t);e&&e.forEach(n=>{n.forEach(r=>{let s=v.get(r);s.has(n)&&s.get(n).delete(t)})})}var k=[],z=[],W=new WeakMap,L=[];function G(t){let e=W.get(t)?.deref();if(!e)return;F(e);let n=e.fn;y.remove(n),W.delete(t)}function J(t,e){if(z.findIndex(l=>t==l)!==-1)throw new Error("Recursive update() call",{cause:t});z.push(t);let n=y.get(t);n||(n=C({current:null}),y.set(t,n));let r=!1,s=!0;return function l(){if(L.findIndex(o=>o==n)!==-1)throw new Error("Cyclical dependency in update() call",{cause:t});if(r&&r>Date.now()){s=!0;return}F(l),k.push(l),L.push(n);let f;try{f=t(l,k,L)}finally{s=!1,k.pop(),L.pop(),f instanceof Promise?f.then(o=>{n.current=o}):n.current=f}r=Date.now()+e,globalThis.setTimeout(()=>{s&&l()},e)}(),n}var B=class{constructor(e){this.bindings=new Map;let n={container:document.body,attribute:"data-bind",transformers:[],defaultTransformers:[le]};if(!e?.root)throw new Error("bind needs at least options.root set");this.options=Object.assign({},n,e);let r=this.options.attribute,s=u=>{this.bindings.set(u,J(()=>{let c={templates:u.querySelectorAll(":scope > template"),path:this.getBindingPath(u)};c.value=x(this.options.root,c.path),c.element=u,i(c)},100))},i=u=>{let c=this.options.defaultTransformers||[];u.element.dataset.transform&&u.element.dataset.transform.split(" ").filter(Boolean).forEach(h=>{this.options.transformers[h]?c.push(this.options.transformers[h]):console.warn("No transformer with name "+h+" configured",{cause:u.element})});let a;for(let h of c)a=((m,p)=>d=>p.call(this,d,m))(a,h);a(u)},l=u=>{for(let c of u)s(c)},f=u=>{for(let c of u)if(c.type=="childList"&&c.addedNodes){for(let a of c.addedNodes)if(a instanceof HTMLElement){let h=Array.from(a.querySelectorAll(`[${r}]`));a.matches(`[${r}]`)&&h.unshift(a),h.length&&l(h)}}};this.observer=new MutationObserver(u=>{f(u)}),this.observer.observe(e.container,{subtree:!0,childList:!0});let o=this.options.container.querySelectorAll("["+this.options.attribute+"]:not(template)");o.length&&l(o)}applyTemplate(e){let n=e.path,r=e.templates,s=e.list,i=e.index,l=e.parent,f=s?s[i]:e.value,o=this.findTemplate(r,f);if(!o){let h=new DocumentFragment;return h.innerHTML="<!-- no matching template -->",h}let u=o.content.cloneNode(!0);if(!u.children?.length)throw new Error("template must contain a single html element",{cause:o});if(u.children.length>1)throw new Error("template must contain a single root node",{cause:o});let c=u.querySelectorAll("["+this.options.attribute+"]"),a=this.options.attribute;for(let h of c){let m=h.getAttribute(a);m.substring(0,6)=="#root."?h.setAttribute(a,m.substring(6)):m=="#value"&&i!=null?h.setAttribute(a,n+"."+i):i!=null?h.setAttribute(a,n+"."+i+"."+m):h.setAttribute(a,l+"."+m)}return typeof i<"u"&&u.children[0].setAttribute(a+"-key",i),u.children[0].$bindTemplate=o,u}getBindingPath(e){return e.getAttribute(this.options.attribute)}findTemplate(e,n){let r=l=>{let f=this.getBindingPath(l),o;f?f.substr(0,6)=="#root."?o=x(this.options.root,f):o=x(n,f):o=n;let u=""+o,c=l.getAttribute(this.options.attribute+"-match");if(c){if(c==="#empty"&&!o)return l;if(c==="#notempty"&&o||u.match(c))return l}if(!c&&o)return l},s=Array.from(e).find(r),i=s?.getAttribute("rel");if(i){let l=document.querySelector("template#"+i);if(!l)throw new Error("Could not find template with id "+i);s=l}return s}destroy(){this.bindings.forEach(e=>{G(e)}),this.bindings=new Map,this.observer.disconnect()}};function Q(t){return new B(t)}function E(t,e){return t=="#empty"&&!e||e=="#empty"&&!t||""+t==""+e}function x(t,e){let n=e.split("."),r=t,s,i;for(;n.length&&r;){if(s=n.shift(),s=="#key")return i;if(s=="#value")return r;s=="#root"?r=t:(s=decodeURIComponent(s),r=r[s],i=s)}return r}function le(t){let e=t.element,n=t.templates,r=n.length,s=t.path,i=t.value,l=this.options.attribute;return Array.isArray(i)&&n?.length?ae.call(this,t):typeof i=="object"&&n?.length?oe.call(this,t):n?.length?fe.call(this,t):e.tagName=="INPUT"?ce.call(this,t):e.tagName=="BUTTON"?ue.call(this,t):e.tagName=="SELECT"?he.call(this,t):e.tagName=="A"?me.call(this,t):de.call(this,t),t}function ae(t){let e=t.element,n=t.templates,r=n.length,s=t.path,i=t.value,l=this.options.attribute,f=e.querySelectorAll(":scope > ["+l+"-key]"),o=0,u=0;t.list=i;for(let a of f){let h=parseInt(a.getAttribute(l+"-key"));if(h>o)t.index=o,e.insertBefore(this.applyTemplate(t),a);else if(h<o)a.remove();else{let m=Array.from(a.querySelectorAll(`[${l}]`));a.matches(`[${l}]`)&&m.unshift(a);let p=m.find(d=>{let T=d.getAttribute(l);return T.substr(0,5)!=="#root"&&T.substr(0,s.length)!==s});if(!p&&a.$bindTemplate){let d=this.findTemplate(n,i[o]);d!=a.$bindTemplate&&(p=!0,d||u++)}p&&(t.index=o,e.replaceChild(this.applyTemplate(t),a))}if(o++,o>=i.length)break}f=e.querySelectorAll(":scope > ["+l+"-key]");let c=f.length+u;if(c>i.length)for(;c>i.length;)e.querySelectorAll(":scope > :not(template)")?.[c-1]?.remove(),c--;else if(c<i.length)for(;c<i.length;)t.index=c,e.appendChild(this.applyTemplate(t)),c++}function oe(t){let e=t.element,n=t.templates,r=n.length,s=t.path,i=t.value,l=this.options.attribute;t.list=i;let f=Object.entries(i),o=e.querySelectorAll(":scope > ["+l+"-key]"),u=0,c=0;for(let h of o){if(u>=f.length)break;let m=f[u][0];u++;let p=s+"."+m,d,T=h.getAttribute(l);if(T&&T.substr(0,p.length)!=p)d=!0;else if(d=Array.from(h.querySelectorAll(`[${l}]`)).find(A=>{let N=A.getAttribute(l);return N.substr(0,5)!=="#root"&&N.substr(0,p.length)!==p}),!d&&h.$bindTemplate){let A=this.findTemplate(n,i[m]);A!=h.$bindTemplate&&(d=!0,A||c++)}if(d){t.index=m;let q=this.applyTemplate(t);e.replaceChild(q,h)}}o=e.querySelectorAll(":scope > ["+l+"-key]");let a=o.length+c;if(a>f.length)for(;a>f.length;)e.querySelectorAll(":scope > :not(template)")?.[a-1]?.remove(),a--;else if(a<f.length)for(;a<f.length;)t.index=f[a][0],e.appendChild(this.applyTemplate(t)),a++}function fe(t){let e=t.element,n=t.templates,r=t.value,s=this.options.attribute,i=e.querySelector(":scope > :not(template)"),l=this.findTemplate(n,r);if(t.parent=e.parentElement?.closest(`[${s}]`)?.getAttribute(s)||"#root",i)if(l){if(i?.$bindTemplate!=l){let f=this.applyTemplate(t);e.replaceChild(f,i)}}else e.removeChild(i);else if(l){let f=this.applyTemplate(t);e.appendChild(f)}}function ce(t){let e=t.element,n=t.value;e.type=="checkbox"||e.type=="radio"?E(e.value,n)?e.checked=!0:e.checked=!1:E(e.value,n)||(e.value=""+n)}function ue(t){let e=t.element,n=t.value;E(e.value,n)||(e.value=""+n)}function he(t){let e=t.element,n=t.value;if(e.multiple){if(Array.isArray(n))for(let r of e.options)n.indexOf(r.value)===!1?r.selected=!1:r.selected=!0}else{let r=e.options.find(s=>E(s.value,n));r&&(r.selected=!0)}}function me(t){let e=t.element,n=t.value;n?.innerHTML&&!E(e.innerHTML,n.innerHTML)&&(e.innerHTML=""+n.innerHTML),n?.href&&!E(e.href,n.href)&&(e.href=""+n.href)}function de(t){let e=t.element,n=t.value;E(e.innerHTML,n)||(e.innerHTML=""+n)}var H=class{constructor(e={}){this.container=e.container||document.body,e.state||(e.state={}),this.state=C(e.state),e.commands&&(this.commands=$({app:this,container:this.container,commands:e.commands})),e.keys&&(this.keys=D({app:this,keys:e.keys})),e.routes&&(this.routes=j({app:this,routes:e.routes})),e.actions&&(this.actions=U({app:this,actions:e.actions}));let n={container:this.container,root:this.state};e.defaultTransformers&&(n.defaultTransformers=e.defaultTransformers),e.transformers&&(n.transformers=e.transformers),this.bind=Q(n)}};function Me(t={}){return new H(t)}})();
//# sourceMappingURL=simply.app.min.js.map
