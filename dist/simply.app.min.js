(()=>{function B(t){return new H(t)}var H=class{constructor(e={}){this.root=e.root||"/",this.app=e.app,this.clear(),e.routes&&this.load(e.routes)}load(e){X(e,this.routeInfo)}clear(){this.routeInfo=[],this.listeners={match:{},call:{},finish:{}}}match(e,n){let r={path:e,options:n};r=this.runListeners("match",r),e=r.path?r.path:e;let i;if(!e)return this.match(document.location.pathname+document.location.hash)?!0:this.match(document.location.pathname);e=w(e);for(let l of this.routeInfo)if(i=l.match.exec(e),i&&i.length){var s={};return l.params.forEach((f,c)=>{f=="*"&&(f="remainder"),s[f]=i[c+1]}),Object.assign(s,n),r.route=l,r.params=s,r=this.runListeners("call",r),s=r.params?r.params:s,r.result=l.action.call(l,s),this.runListeners("finish",r),r.result}return e&&e[e.length-1]!="/"?this.match(e+"/",n):!1}runListeners(e,n){if(!!Object.keys(this.listeners[e]))return Object.keys(this.listeners[e]).forEach(r=>{var i=N(r);if(i.exec(n.path)){var s;for(let l of this.listeners[e][r])s=l.call(this.app,n),s&&(n=s)}}),n}handleEvents(){globalThis.addEventListener("popstate",()=>{this.match(w(document.location.pathname+document.location.hash,this.root))===!1&&this.match(w(document.location.pathname,this.root))}),globalThis.document.addEventListener("click",e=>{if(!e.ctrlKey&&e.which==1){for(var n=e.target;n&&n.tagName!="A";)n=n.parentElement;if(n&&n.pathname&&n.hostname==globalThis.location.hostname&&!n.link&&!n.dataset.simplyCommand){let r=w(n.pathname+n.hash,this.root);if(this.has(r)||(r=w(n.pathname,this.root)),this.has(r)){let i=this.runListeners("goto",{path:r});return i.path&&this.goto(i.path),e.preventDefault(),!1}}}})}goto(e){return history.pushState({},"",Q(e)),this.match(e)}has(e){e=w(e,this.root);for(let r of this.routeInfo){var n=r.match.exec(e);if(n&&n.length)return!0}return!1}addListener(e,n,r){if(["goto","match","call","finish"].indexOf(e)==-1)throw new Error("Unknown action "+e);this.listeners[e][n]||(this.listeners[e][n]=[]),this.listeners[e][n].push(r)}removeListener(e,n,r){if(["match","call","finish"].indexOf(e)==-1)throw new Error("Unknown action "+e);!this.listeners[e][n]||(this.listeners[e][n]=this.listeners[e][n].filter(i=>i!=r))}init(e){e.root&&(this.root=e.root)}};function w(t,e="/"){return(t.substring(0,e.length)==e||e[e.length-1]=="/"&&t.length==e.length-1&&t==e.substring(0,t.length))&&(t=t.substring(e.length)),t[0]!="/"&&t[0]!="#"&&(t="/"+t),t}function Q(t,e){return t=w(t,e),e[e.length-1]==="/"&&t[0]==="/"&&(t=t.substring(1)),e+t}function N(t){return new RegExp("^"+t.replace(/:\w+/g,"([^/]+)").replace(/:\*/,"(.*)"))}function X(t){let e=[],n=Object.keys(t),r=/:(\w+|\*)/g;for(let i of n){let s=[],l=[];do s=r.exec(i),s&&l.push(s[1]);while(s);e.push({match:N(i),params:l,action:t[i]})}return e}var j=class{constructor(e={}){e.app||(e.app={}),e.app.container||(e.app.container=document.body),this.app=e.app,this.handlers=e.handlers||Z,this.commands=e.commands||{};let n=i=>{let s=Y(i,this.handlers);if(!!s){if(!this.commands[s.name]){console.error("simply.command: undefined command "+s.name,s.source);return}this.commands[s.name].call(this.app,s.source,s.value)}};function r(i){return s=>(i(s),s.preventDefault(),s.stopPropagation(),!1)}this.app.container.addEventListener("click",r(n)),this.app.container.addEventListener("submit",r(n)),this.app.container.addEventListener("change",n),this.app.container.addEventListener("input",n)}};function q(t={}){return new j(t)}function Y(t,e){var n=t.target.closest("[data-simply-command]");if(n){for(var r=e.length-1;r>=0;r--)if(n.matches(e[r].match)&&e[r].check(n,t))return{name:n.dataset.simplyCommand,source:n,value:e[r].get(n)}}return null}var Z=[{match:"input,select,textarea",get:function(t){if(t.tagName==="SELECT"&&t.multiple){let e=[];for(let n of t.options)n.selected&&e.push(n.value);return e}return t.dataset.simplyValue||t.value},check:function(t,e){return e.type=="change"||t.dataset.simplyImmediate&&e.type=="input"}},{match:"a,button",get:function(t){return t.dataset.simplyValue||t.href||t.value},check:function(t,e){return e.type=="click"&&e.ctrlKey==!1&&e.button==0}},{match:"form",get:function(t){let e={};for(let n of Array.from(t.elements)){if(n.tagName=="INPUT"&&(n.type=="checkbox"||n.type=="radio")&&!n.checked)return;e[n.name]&&!Array.isArray(e[n.name])&&(e[n.name]=[e[n.name]]),Array.isArray(e[n.name])?e[n.name].push(n.value):e[n.name]=n.value}return e},check:function(t,e){return e.type=="submit"}},{match:"*",get:function(t){return t.dataset.simplyValue},check:function(t,e){return e.type=="click"&&e.ctrlKey==!1&&e.button==0}}];var K=class{constructor(e){this.app=e.app;let n={get:(r,i)=>r[i].bind(this.app)};this.actions=new Proxy({},n),Object.assign(this.actions,e.actions)}};function R(t){return new K(t)}var U=class{constructor(e={}){e.app||(e.app={}),e.app.container||(e.app.container=document.body),this.app=e.app,this.app.container.addEventListener("keydown",_(this.keys))}};function $(t={}){return new U(t)}function _(t){return e=>{if(e.isComposing||e.keyCode===229||e.defaultPrevented||!e.target)return;let n="default";e.target.closest("[data-simply-keyboard]")&&(n=e.target.closest("[data-simply-keyboard]").dataset.simplyKeyboard);let r="";if(e.ctrlKey&&e.keyCode!=17&&(r+="Control+"),e.metaKey&&e.keyCode!=224&&(r+="Meta+"),e.altKey&&e.keyCode!=18&&(r+="Alt+"),e.shiftKey&&e.keyCode!=16&&(r+="Shift+"),r+=e.key,t[n]&&t[n][r]){let i=t[n];i.app=t.app,i[r].call(t.app,e)}}}var D=Symbol("source"),M=Symbol("iterate"),ee={get:(t,e,n)=>{if(e===D)return t;let r=t?.[e];return x(n,e),typeof r=="function"?Array.isArray(t)?(...i)=>{let s=t.length,l=r.apply(n,i);return s!=t.length&&k(n,y("length",{was:s,now:t.length})),l}:t instanceof Set||t instanceof Map?(...i)=>{let s=t.size,l=r.apply(t,i);return s!=t.size&&k(n,y("size",{was:s,now:t.size})),["set","add","clear","delete"].includes(e)&&k(n,y({entries:{},forEach:{},has:{},keys:{},values:{},[Symbol.iterator]:{}})),l}:r.bind(n):r&&typeof r=="object"?L(r):r},set:(t,e,n,r)=>{n=n?.[D]||n;let i=t[e];return i!==n&&(t[e]=n,k(r,y(e,{was:i,now:n}))),typeof i=="undefined"&&k(r,y(M,{})),!0},has:(t,e)=>{let n=g.get(t);return n&&x(n,e),Object.hasOwn(t,e)},deleteProperty:(t,e)=>{if(typeof t[e]!="undefined"){let n=t[e];delete t[e];let r=g.get(t);k(r,y(e,{delete:!0,was:n}))}return!0},defineProperty:(t,e,n)=>{if(typeof t[e]=="undefined"){let r=g.get(t);k(r,y(M,{}))}return Object.defineProperty(t,e,n)},ownKeys:t=>{let e=g.get(t);return x(e,M),Reflect.ownKeys(t)}},g=new WeakMap;function L(t){return g.has(t)||g.set(t,new Proxy(t,ee)),g.get(t)}var V=new Set,te=0;function k(t,e={}){let n=[];if(e.forEach((r,i)=>{let s=ie(t,i);if(s?.length){for(let l of s)ne(l,y(i,r));n=n.concat(s)}}),n=new Set(n.filter(Boolean)),n)if(te)V=V.union(n);else{let r=E[E.length-1];for(let i of Array.from(n))i!=r&&i?.needsUpdate&&i(),re(i)}}function y(t,e){let n=new Map;if(typeof t=="object")for(let r in t)n.set(r,t[r]);else n.set(t,e);return n}function ne(t,e){t.context?e.forEach((n,r)=>{t.context.set(r,n)}):t.context=e,t.needsUpdate=!0}function re(t){delete t.context,delete t.needsUpdate}function x(t,e){let n=E[E.length-1];n&&se(t,e,n)}var v=new WeakMap,S=new WeakMap;function ie(t,e){let n=v.get(t);return n?Array.from(n.get(e)||[]):[]}function se(t,e,n){v.has(t)||v.set(t,new Map);let r=v.get(t);r.has(e)||r.set(e,new Set),r.get(e).add(n),S.has(n)||S.set(n,new Map);let i=S.get(n);i.has(e)||i.set(e,new Set),i.get(e).add(t)}function le(t){let e=S.get(t);e&&e.forEach(n=>{n.forEach(r=>{let i=v.get(r);i.has(n)&&i.get(n).delete(t)})})}var E=[],z=[];var C=[];function W(t,e){if(z.findIndex(l=>t==l)!==-1)throw new Error("Recursive update() call",{cause:t});z.push(t);let n=g.get(t);n||(n=L({current:null}),g.set(t,n));let r=!1,i=!0;return function l(){if(C.findIndex(c=>c==n)!==-1)throw new Error("Cyclical dependency in update() call",{cause:t});if(r&&r>Date.now()){i=!0;return}le(l),E.push(l),C.push(n);let f;try{f=t(l,E,C)}finally{i=!1,E.pop(),C.pop(),f instanceof Promise?f.then(c=>{n.current=c}):n.current=f}r=Date.now()+e,globalThis.setTimeout(()=>{i&&l()},e)}(),n}var F=class{constructor(e){let n={container:document.body,attribute:"data-bind",transformers:[],defaultTransformers:[ae]};if(!e?.root)throw new Error("bind needs at least options.root set");this.options=Object.assign({},n,e);let r=this.options.attribute,i=a=>{W(()=>{let o={templates:a.querySelectorAll(":scope > template"),path:this.getBindingPath(a)};o.value=P(this.options.root,o.path),o.element=a,s(o)},100)},s=a=>{let o=this.options.defaultTransformers||[];a.element.dataset.transform&&a.element.dataset.transform.split(" ").filter(Boolean).forEach(m=>{this.options.transformers[m]?o.push(this.options.transformers[m]):console.warn("No transformer with name "+m+" configured",{cause:a.element})});let u;for(let m of o)u=((p,d)=>b=>d.call(this,b,p))(u,m);u(a)},l=a=>{for(let o of a)i(o)},f=a=>{for(let o of a)if(o.type=="childList"&&o.addedNodes){for(let u of o.addedNodes)if(u instanceof HTMLElement){let m=Array.from(u.querySelectorAll(`[${r}]`));u.matches(`[${r}]`)&&m.unshift(u),m.length&&l(m)}}};new MutationObserver(a=>{f(a)}).observe(e.container,{subtree:!0,childList:!0});let h=this.options.container.querySelectorAll("["+this.options.attribute+"]:not(template)");h.length&&l(h)}applyTemplate(e,n,r,i){let s=this.findTemplate(n,r[i]);if(!s){let h=new DocumentFragment;return h.innerHTML="<!-- no matching template -->",h}let l=s.content.cloneNode(!0);if(!l.children?.length)throw new Error("template must contain a single html element",{cause:s});if(l.children.length>1)throw new Error("template must contain a single root node",{cause:s});let f=l.querySelectorAll("["+this.options.attribute+"]"),c=this.options.attribute;for(let h of f){let a=h.getAttribute(c);a.substring(0,"#root.".length)=="#root."?h.setAttribute(c,a.substring("#root.".length)):a=="#value"?h.setAttribute(c,e+"."+i):h.setAttribute(c,e+"."+i+"."+a)}return l.children[0].setAttribute(c+"-key",i),l.children[0].$bindTemplate=s,l}getBindingPath(e){return e.getAttribute(this.options.attribute)}findTemplate(e,n){let r=l=>{let f=this.getBindingPath(l);if(!f)return l;let c;f.substr(0,6)=="#root."?c=P(this.options.root,f):c=P(n,f);let h=""+c,a=l.getAttribute(this.options.attribute+"-matches");if(a){if(a==="#empty"&&!c)return l;if(a==="#notempty"&&c||h.match(a))return l}if(!a&&c)return l},i=Array.from(e).find(r),s=i?.getAttribute("rel");if(s){let l=document.querySelector("template#"+s);if(!l)throw new Error("Could not find template with id "+s);i=l}return i}};function G(t){return new F(t)}function A(t,e){return t=="#empty"&&!e||e=="#empty"&&!t||""+t==""+e}function P(t,e){let n=e.split("."),r=t,i,s;for(;n.length&&r;){if(i=n.shift(),i=="#key")return s;if(i=="#value")return r;i=="#root"?r=t:(i=decodeURIComponent(i),r=r[i],s=i)}return r}function ae(t){let e=t.element,n=t.templates,r=n.length,i=t.path,s=t.value,l=this.options.attribute;return Array.isArray(s)&&n?.length?oe.call(this,t):s&&typeof s=="object"&&n?.length?ce.call(this,t):e.tagName=="INPUT"?fe.call(this,t):e.tagName=="BUTTON"?ue.call(this,t):e.tagName=="SELECT"?he.call(this,t):e.tagName=="A"?me.call(this,t):de.call(this,t),t}function oe(t){let e=t.element,n=t.templates,r=n.length,i=t.path,s=t.value,l=this.options.attribute,f=e.querySelectorAll(":scope > ["+l+"-key]"),c=0,h=0;for(let o of f){let u=parseInt(o.getAttribute(l+"-key"));if(u>c)e.insertBefore(this.applyTemplate(i,n,s,c),o);else if(u<c)o.remove();else{let m=Array.from(o.querySelectorAll(`[${l}]`));o.matches(`[${l}]`)&&m.unshift(o);let p=m.find(d=>{let b=d.getAttribute(l);return b.substr(0,5)!=="#root"&&b.substr(0,i.length)!==i});if(!p&&o.$bindTemplate){let d=this.findTemplate(n,s[c]);d!=o.$bindTemplate&&(p=!0,d||h++)}p&&e.replaceChild(this.applyTemplate(i,n,s,c),o)}if(c++,c>=s.length)break}f=e.querySelectorAll(":scope > ["+l+"-key]");let a=f.length+h;if(a>s.length)for(;a>s.length;)e.querySelectorAll(":scope > :not(template)")?.[a-1]?.remove(),a--;else if(a<s.length)for(;a<s.length;)e.appendChild(this.applyTemplate(i,n,s,a)),a++}function ce(t){let e=t.element,n=t.templates,r=n.length,i=t.path,s=t.value,l=this.options.attribute,f=Object.entries(s),c=e.querySelectorAll(":scope > ["+l+"-key]"),h=0,a=0;for(let u of c){if(h>=f.length)break;let m=f[h][0];h++;let p=i+"."+m,d,b=u.getAttribute(l);if(b&&b.substr(0,p.length)!=p)d=!0;else if(d=Array.from(u.querySelectorAll(`[${l}]`)).find(T=>{let O=T.getAttribute(l);return O.substr(0,5)!=="#root"&&O.substr(0,p.length)!==p}),!d&&u.$bindTemplate){let T=this.findTemplate(n,s[m]);T!=u.$bindTemplate&&(d=!0,T||a++)}if(d){let I=this.applyTemplate(i,n,s,m);e.replaceChild(I,u)}}c=e.querySelectorAll(":scope > ["+l+"-key]");let o=c.length+a;if(o>f.length)for(;o>f.length;)e.querySelectorAll(":scope > :not(template)")?.[o-1]?.remove(),o--;else if(o<f.length)for(;o<f.length;){let u=f[o][0];e.appendChild(this.applyTemplate(i,n,s,u)),o++}}function fe(t){let e=t.element,n=t.value;e.type=="checkbox"||e.type=="radio"?A(e.value,n)?e.checked=!0:e.checked=!1:A(e.value,n)||(e.value=""+n)}function ue(t){let e=t.element,n=t.value;A(e.value,n)||(e.value=""+n)}function he(t){let e=t.element,n=t.value;if(e.multiple){if(Array.isArray(n))for(let r of e.options)n.indexOf(r.value)===!1?r.selected=!1:r.selected=!0}else{let r=e.options.find(i=>A(i.value,n));r&&(r.selected=!0)}}function me(t){let e=t.element,n=t.value;n?.innerHTML&&!A(e.innerHTML,n.innerHTML)&&(e.innerHTML=""+n.innerHTML),n?.href&&!A(e.href,n.href)&&(e.href=""+n.href)}function de(t){let e=t.element,n=t.value;A(e.innerHTML,n)||(e.innerHTML=""+n)}var J=class{constructor(e={}){this.container=e.container||document.body,e.state&&(this.state=L(e.state)),e.commands&&(this.commands=q({app:this,container:this.container,commands:e.commands})),e.keys&&(this.keys=$({app:this,keys:e.keys})),e.routes&&(this.routes=B({app:this,routes:e.routes})),e.actions&&(this.actions=R({app:this,actions:e.actions})),G({container:this.container,state:this.state})}};function Me(t={}){return new J(t)}})();
//# sourceMappingURL=simply.app.min.js.map
