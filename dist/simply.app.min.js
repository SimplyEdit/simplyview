(()=>{function H(t){return new S(t)}var S=class{constructor(e={}){this.root=e.root||"/",this.app=e.app,this.clear(),e.routes&&this.load(e.routes)}load(e){X(e,this.routeInfo)}clear(){this.routeInfo=[],this.listeners={match:{},call:{},finish:{}}}match(e,n){let r={path:e,options:n};r=this.runListeners("match",r),e=r.path?r.path:e;let i;if(!e)return this.match(document.location.pathname+document.location.hash)?!0:this.match(document.location.pathname);e=w(e);for(let l of this.routeInfo)if(i=l.match.exec(e),i&&i.length){var s={};return l.params.forEach((o,a)=>{o=="*"&&(o="remainder"),s[o]=i[a+1]}),Object.assign(s,n),r.route=l,r.params=s,r=this.runListeners("call",r),s=r.params?r.params:s,r.result=l.action.call(l,s),this.runListeners("finish",r),r.result}return e&&e[e.length-1]!="/"?this.match(e+"/",n):!1}runListeners(e,n){if(Object.keys(this.listeners[e]))return Object.keys(this.listeners[e]).forEach(r=>{var i=R(r);if(i.exec(n.path)){var s;for(let l of this.listeners[e][r])s=l.call(this.app,n),s&&(n=s)}}),n}handleEvents(){globalThis.addEventListener("popstate",()=>{this.match(w(document.location.pathname+document.location.hash,this.root))===!1&&this.match(w(document.location.pathname,this.root))}),globalThis.document.addEventListener("click",e=>{if(!e.ctrlKey&&e.which==1){for(var n=e.target;n&&n.tagName!="A";)n=n.parentElement;if(n&&n.pathname&&n.hostname==globalThis.location.hostname&&!n.link&&!n.dataset.simplyCommand){let r=w(n.pathname+n.hash,this.root);if(this.has(r)||(r=w(n.pathname,this.root)),this.has(r)){let i=this.runListeners("goto",{path:r});return i.path&&this.goto(i.path),e.preventDefault(),!1}}}})}goto(e){return history.pushState({},"",Q(e)),this.match(e)}has(e){e=w(e,this.root);for(let r of this.routeInfo){var n=r.match.exec(e);if(n&&n.length)return!0}return!1}addListener(e,n,r){if(["goto","match","call","finish"].indexOf(e)==-1)throw new Error("Unknown action "+e);this.listeners[e][n]||(this.listeners[e][n]=[]),this.listeners[e][n].push(r)}removeListener(e,n,r){if(["match","call","finish"].indexOf(e)==-1)throw new Error("Unknown action "+e);this.listeners[e][n]&&(this.listeners[e][n]=this.listeners[e][n].filter(i=>i!=r))}init(e){e.root&&(this.root=e.root)}};function w(t,e="/"){return(t.substring(0,e.length)==e||e[e.length-1]=="/"&&t.length==e.length-1&&t==e.substring(0,t.length))&&(t=t.substring(e.length)),t[0]!="/"&&t[0]!="#"&&(t="/"+t),t}function Q(t,e){return t=w(t,e),e[e.length-1]==="/"&&t[0]==="/"&&(t=t.substring(1)),e+t}function R(t){return new RegExp("^"+t.replace(/:\w+/g,"([^/]+)").replace(/:\*/,"(.*)"))}function X(t){let e=[],n=Object.keys(t),r=/:(\w+|\*)/g;for(let i of n){let s=[],l=[];do s=r.exec(i),s&&l.push(s[1]);while(s);e.push({match:R(i),params:l,action:t[i]})}return e}var M=class{constructor(e={}){e.app||(e.app={}),e.app.container||(e.app.container=document.body),this.$handlers=e.handlers||Z,e.commands&&Object.assign(this,e.commands);let n=r=>{let i=Y(r,this.$handlers);if(!i)return;if(!this[i.name]){console.error("simply.command: undefined command "+i.name,i.source);return}if(this[i.name].call(e.app,i.source,i.value)!==!0)return r.preventDefault(),r.stopPropagation(),!1};e.app.container.addEventListener("click",n),e.app.container.addEventListener("submit",n),e.app.container.addEventListener("change",n),e.app.container.addEventListener("input",n)}};function j(t={}){return new M(t)}function Y(t,e){var n=t.target.closest("[data-simply-command]");if(n){for(let r of e)if(n.matches(r.match))return r.check(n,t)?{name:n.dataset.simplyCommand,source:n,value:r.get(n)}:null}return null}var Z=[{match:"input,select,textarea",get:function(t){if(t.tagName==="SELECT"&&t.multiple){let e=[];for(let n of t.options)n.selected&&e.push(n.value);return e}return t.dataset.simplyValue||t.value},check:function(t,e){return e.type=="change"||t.dataset.simplyImmediate&&e.type=="input"}},{match:"a,button",get:function(t){return t.dataset.simplyValue||t.href||t.value},check:function(t,e){return e.type=="click"&&e.ctrlKey==!1&&e.button==0}},{match:"form",get:function(t){let e={};for(let n of Array.from(t.elements)){if(n.tagName=="INPUT"&&(n.type=="checkbox"||n.type=="radio")&&!n.checked)return;e[n.name]&&!Array.isArray(e[n.name])&&(e[n.name]=[e[n.name]]),Array.isArray(e[n.name])?e[n.name].push(n.value):e[n.name]=n.value}return e},check:function(t,e){return e.type=="submit"}},{match:"*",get:function(t){return t.dataset.simplyValue},check:function(t,e){return e.type=="click"&&e.ctrlKey==!1&&e.button==0}}];function q(t){if(t.app){let e={get:(n,r)=>n[r].bind(t.app)};return new Proxy(t.actions,e)}else return t}var $=class{constructor(e={}){e.app||(e.app={}),e.app.container||(e.app.container=document.body),Object.assign(this,e.keys);let n=r=>{if(r.isComposing||r.keyCode===229||r.defaultPrevented||!r.target)return;let i="default";r.target.closest("[data-simply-keyboard]")&&(i=r.target.closest("[data-simply-keyboard]").dataset.simplyKeyboard);let s="";r.ctrlKey&&r.keyCode!=17&&(s+="Control+"),r.metaKey&&r.keyCode!=224&&(s+="Meta+"),r.altKey&&r.keyCode!=18&&(s+="Alt+"),r.shiftKey&&r.keyCode!=16&&(s+="Shift+"),s+=r.key,this[i]&&this[i][s]&&this[i][s].call(e.app,r)};e.app.container.addEventListener("keydown",n)}};function K(t={}){return new $(t)}var P=Symbol("iterate");Symbol.xRay||(Symbol.xRay=Symbol("xRay"));var _={get:(t,e,n)=>{if(e===Symbol.xRay)return t;let r=t?.[e];return O(n,e),typeof r=="function"?Array.isArray(t)?(...i)=>{let s=t.length,l=r.apply(n,i);return s!=t.length&&k(n,g("length",{was:s,now:t.length})),l}:t instanceof Set||t instanceof Map?(...i)=>{let s=t.size,l=r.apply(t,i);return s!=t.size&&k(n,g("size",{was:s,now:t.size})),["set","add","clear","delete"].includes(e)&&k(n,g({entries:{},forEach:{},has:{},keys:{},values:{},[Symbol.iterator]:{}})),l}:t instanceof HTMLElement||t instanceof Number||t instanceof String||t instanceof Boolean?r.bind(t):r.bind(n):r&&typeof r=="object"?C(r):r},set:(t,e,n,r)=>{n=n?.[Symbol.xRay]||n;let i=t[e];return i!==n&&(t[e]=n,k(r,g(e,{was:i,now:n}))),typeof i>"u"&&k(r,g(P,{})),!0},has:(t,e)=>{let n=y.get(t);return n&&O(n,e),Object.hasOwn(t,e)},deleteProperty:(t,e)=>{if(typeof t[e]<"u"){let n=t[e];delete t[e];let r=y.get(t);k(r,g(e,{delete:!0,was:n}))}return!0},defineProperty:(t,e,n)=>{if(typeof t[e]>"u"){let r=y.get(t);k(r,g(P,{}))}return Object.defineProperty(t,e,n)},ownKeys:t=>{let e=y.get(t);return O(e,P),Reflect.ownKeys(t)}},y=new WeakMap;function C(t){return y.has(t)||y.set(t,new Proxy(t,_)),y.get(t)}var U=new Set,ee=0;function k(t,e={}){let n=[];if(e.forEach((r,i)=>{let s=re(t,i);if(s?.length){for(let l of s)te(l,g(i,r));n=n.concat(s)}}),n=new Set(n.filter(Boolean)),n)if(ee)U=U.union(n);else{let r=T[T.length-1];for(let i of Array.from(n))i!=r&&i?.needsUpdate&&i(),ne(i)}}function g(t,e){let n=new Map;if(typeof t=="object")for(let r in t)n.set(r,t[r]);else n.set(t,e);return n}function te(t,e){t.context?e.forEach((n,r)=>{t.context.set(r,n)}):t.context=e,t.needsUpdate=!0}function ne(t){delete t.context,delete t.needsUpdate}function O(t,e){let n=T[T.length-1];n&&ie(t,e,n)}var v=new WeakMap,L=new WeakMap;function re(t,e){let n=v.get(t);return n?Array.from(n.get(e)||[]):[]}function ie(t,e,n){v.has(t)||v.set(t,new Map);let r=v.get(t);r.has(e)||r.set(e,new Set),r.get(e).add(n),L.has(n)||L.set(n,new Map);let i=L.get(n);i.has(e)||i.set(e,new Set),i.get(e).add(t)}function D(t){let e=L.get(t);e&&e.forEach(n=>{n.forEach(r=>{let i=v.get(r);i.has(n)&&i.get(n).delete(t)})})}var T=[],V=[],x=new WeakMap,A=[];function z(t){let e=x.get(t)?.deref();if(!e)return;D(e);let n=e.fn;y.remove(n),x.delete(t)}function W(t,e){if(V.findIndex(l=>t==l)!==-1)throw new Error("Recursive update() call",{cause:t});V.push(t);let n=y.get(t);n||(n=C({current:null}),y.set(t,n));let r=!1,i=!0;return function l(){if(A.findIndex(a=>a==n)!==-1)throw new Error("Cyclical dependency in update() call",{cause:t});if(r&&r>Date.now()){i=!0;return}D(l),T.push(l),A.push(n);let o;try{o=t(l,T,A)}finally{i=!1,T.pop(),A.pop(),o instanceof Promise?o.then(a=>{n.current=a}):n.current=o}r=Date.now()+e,globalThis.setTimeout(()=>{i&&l()},e)}(),n}var I=class{constructor(e){this.bindings=new Map;let n={container:document.body,attribute:"data-bind",transformers:[],defaultTransformers:{field:[se],list:[le],map:[ae]}};if(!e?.root)throw new Error("bind needs at least options.root set");this.options=Object.assign({},n,e);let r=this.options.attribute,i=[r+"-field",r+"-list",r+"-map"],s=`[${r}-field],[${r}-list],[${r}-map]`,l=u=>{let f=i.find(p=>u.hasAttribute(p));return f||console.error("No matching attribute found",u),f},o=u=>{this.bindings.set(u,W(()=>{let f={templates:u.querySelectorAll(":scope > template"),attribute:l(u)};f.path=this.getBindingPath(u),f.value=B(this.options.root,f.path),f.element=u,a(f)},100))},a=u=>{let f;switch(u.attribute){case this.options.attribute+"-field":f=this.options.defaultTransformers.field||[];break;case this.options.attribute+"-list":f=this.options.defaultTransformers.list||[];break;case this.options.attribute+"-map":f=this.options.defaultTransformers.map||[];break}u.element.dataset.transform&&u.element.dataset.transform.split(" ").filter(Boolean).forEach(d=>{this.options.transformers[d]?f.push(this.options.transformers[d]):console.warn("No transformer with name "+d+" configured",{cause:u.element})});let p;for(let d of f)p=((b,G)=>J=>G.call(this,J,b))(p,d);p(u)},h=u=>{for(let f of u)o(f)},c=u=>{let f=`[${r}-field],[${r}-list],[${r}-map]`;for(let p of u)if(p.type=="childList"&&p.addedNodes){for(let d of p.addedNodes)if(d instanceof HTMLElement){let b=Array.from(d.querySelectorAll(f));d.matches(f)&&b.unshift(d),b.length&&h(b)}}};this.observer=new MutationObserver(u=>{c(u)}),this.observer.observe(e.container,{subtree:!0,childList:!0});let m=this.options.container.querySelectorAll("["+this.options.attribute+"-field],["+this.options.attribute+"-list],["+this.options.attribute+"-map]");m.length&&h(m)}applyTemplate(e){let n=e.path,r=e.templates,i=e.list,s=e.index,l=e.parent,o=i?i[s]:e.value,a=this.findTemplate(r,o);if(!a){let f=new DocumentFragment;return f.innerHTML="<!-- no matching template -->",f}let h=a.content.cloneNode(!0);if(!h.children?.length)throw new Error("template must contain a single html element",{cause:a});if(h.children.length>1)throw new Error("template must contain a single root node",{cause:a});let c=this.options.attribute,m=[c+"-field",c+"-list",c+"-map"],u=h.querySelectorAll(`[${c}-field],[${c}-list],[${c}-map]`);for(let f of u){let p=m.find(b=>f.hasAttribute(b)),d=f.getAttribute(p);d.substring(0,6)==":root."?f.setAttribute(p,d.substring(6)):d==":value"&&s!=null?f.setAttribute(p,n+"."+s):s!=null?f.setAttribute(p,n+"."+s+"."+d):f.setAttribute(p,l+"."+d)}return typeof s<"u"&&h.children[0].setAttribute(c+"-key",s),h.children[0].$bindTemplate=a,h}getBindingPath(e){let n=[this.options.attribute+"-field",this.options.attribute+"-list",this.options.attribute+"-map"];for(let r of n)if(e.hasAttribute(r))return e.getAttribute(r)}findTemplate(e,n){let r=l=>{let o=this.getBindingPath(l),a;o?o.substr(0,6)==":root."?a=B(this.options.root,o):a=B(n,o):a=n;let h=""+a,c=l.getAttribute(this.options.attribute+"-match");if(c){if(c===":empty"&&!a)return l;if(c===":notempty"&&a||h.match(c))return l}if(!c&&a!==null&&a!==void 0)return l},i=Array.from(e).find(r),s=i?.getAttribute("rel");if(s){let l=document.querySelector("template#"+s);if(!l)throw new Error("Could not find template with id "+s);i=l}return i}destroy(){this.bindings.forEach(e=>{z(e)}),this.bindings=new Map,this.observer.disconnect()}};function F(t){return new I(t)}function E(t,e){return t==":empty"&&!e||e==":empty"&&!t||""+t==""+e}function B(t,e){let n=e.split("."),r=t,i,s;for(;n.length&&r;){if(i=n.shift(),i==":key")return s;if(i==":value")return r;i==":root"?r=t:(i=decodeURIComponent(i),r=r[i],s=i)}return r}function se(t){let e=t.element,n=t.templates,r=n.length,i=t.path,s=t.value,l=this.options.attribute;return n?.length?ce.call(this,t):e.tagName=="INPUT"?he.call(this,t):e.tagName=="BUTTON"?me.call(this,t):e.tagName=="SELECT"?de.call(this,t):e.tagName=="A"?pe.call(this,t):be.call(this,t),t}function le(t){let e=t.element,n=t.templates,r=n.length,i=t.path,s=t.value,l=this.options.attribute;return Array.isArray(s)?n?.length?oe.call(this,t):console.error("No templates found in",e):console.error("Value is not an array.",e,s),t}function ae(t){let e=t.element,n=t.templates,r=n.length,i=t.path,s=t.value,l=this.options.attribute;return typeof s!="object"?console.error("Value is not an object.",e,s):n?.length?fe.call(this,t):console.error("No templates found in",e),t}function oe(t){let e=t.element,n=t.templates,r=n.length,i=t.path,s=t.value,l=this.options.attribute,o=e.querySelectorAll(":scope > ["+l+"-key]"),a=0,h=0;t.list=s;for(let m of o){let u=parseInt(m.getAttribute(l+"-key"));if(u>a)t.index=a,e.insertBefore(this.applyTemplate(t),m);else if(u<a)m.remove();else{let f=Array.from(m.querySelectorAll(`[${l}]`));m.matches(`[${l}]`)&&f.unshift(m);let p=f.find(d=>{let b=d.getAttribute(l);return b.substr(0,5)!==":root"&&b.substr(0,i.length)!==i});if(!p&&m.$bindTemplate){let d=this.findTemplate(n,s[a]);d!=m.$bindTemplate&&(p=!0,d||h++)}p&&(t.index=a,e.replaceChild(this.applyTemplate(t),m))}if(a++,a>=s.length)break}o=e.querySelectorAll(":scope > ["+l+"-key]");let c=o.length+h;if(c>s.length)for(;c>s.length;)e.querySelectorAll(":scope > :not(template)")?.[c-1]?.remove(),c--;else if(c<s.length)for(;c<s.length;)t.index=c,e.appendChild(this.applyTemplate(t)),c++}function fe(t){let e=t.element,n=t.templates,r=n.length,i=t.path,s=t.value,l=this.options.attribute;t.list=s;let o=Array.from(e.querySelectorAll(":scope > ["+l+"-key]"));for(let a in t.list){t.index=a;let h=o.shift();if(!h){e.appendChild(this.applyTemplate(t));continue}if(h.getAttribute[l+"-key"]!=a){o.unshift(h);let m=e.querySelector(":scope > ["+l+'-key="'+a+'"]');if(m)e.insertBefore(m,h),h=m,o=o.filter(u=>u!=m);else{let u=this.applyTemplate(t);u.firstElementChild&&e.insertBefore(u,h);continue}}if(this.findTemplate(n,s[a])!=h.$bindTemplate){let m=this.applyTemplate(t);e.replaceChild(m,h)}}for(;o.length;)item=o.shift(),item.remove()}function ue(t,e){let n=t.parentElement?.closest(`[${e}-list],[${e}-map]`);return n?n.hasAttribute(`${e}-list`)?n.getAttribute(`${e}-list`):n.getAttribute(`${e}-map`):":root"}function ce(t){let e=t.element,n=t.templates,r=t.value,i=this.options.attribute,s=e.querySelector(":scope > :not(template)"),l=this.findTemplate(n,r);if(t.parent=ue(e,i),s)if(l){if(s?.$bindTemplate!=l){let o=this.applyTemplate(t);e.replaceChild(o,s)}}else e.removeChild(s);else if(l){let o=this.applyTemplate(t);e.appendChild(o)}}function he(t){let e=t.element,n=t.value;e.type=="checkbox"||e.type=="radio"?E(e.value,n)?e.checked=!0:e.checked=!1:E(e.value,n)||(e.value=""+n)}function me(t){let e=t.element,n=t.value;E(e.value,n)||(e.value=""+n)}function de(t){let e=t.element,n=t.value;if(e.multiple){if(Array.isArray(n))for(let r of e.options)n.indexOf(r.value)===!1?r.selected=!1:r.selected=!0}else{let r=e.options.find(i=>E(i.value,n));r&&(r.selected=!0)}}function pe(t){let e=t.element,n=t.value;n?.innerHTML&&!E(e.innerHTML,n.innerHTML)&&(e.innerHTML=""+n.innerHTML),n?.href&&!E(e.href,n.href)&&(e.href=""+n.href)}function be(t){let e=t.element,n=t.value;E(e.innerHTML,n)||(typeof n>"u"||n==null?e.innerHTML="":e.innerHTML=""+n)}var N=class{constructor(e={}){this.container=e.container||document.body,e.state||(e.state={}),this.state=C(e.state),e.commands&&(this.commands=j({app:this,container:this.container,commands:e.commands})),e.keys&&(this.keys=K({app:this,keys:e.keys})),e.routes&&(this.routes=H({app:this,routes:e.routes})),e.actions&&(this.actions=q({app:this,actions:e.actions}));let n={container:this.container,root:this.state};e.defaultTransformers&&(n.defaultTransformers=e.defaultTransformers),e.transformers&&(n.transformers=e.transformers),this.bind=F(n)}};function Pe(t={}){return new N(t)}})();
//# sourceMappingURL=simply.app.min.js.map
